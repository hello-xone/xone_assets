name: Validate Token Info

on:
  pull_request:
    paths:
      - "blockchains/*/info/info.json"
      - "blockchains/*/assets/*/info.json"
      - "dapps/*.png"

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq file

      - name: Make validation script executable
        run: chmod +x validate_info_json.sh

      - name: Validate JSON files
        id: validate_json
        run: |
          echo "ðŸ” Validating token info JSON files..."
          if ./validate_info_json.sh; then
            echo "âœ… All JSON files are valid!"
            echo "json_valid=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ JSON validation failed!"
            echo "json_valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Check icon files
        if: always()
        run: |
          echo "ðŸ–¼ï¸ Checking icon files..."

          # Find all PNG files in blockchains directory
          png_files=$(find blockchains -name "*.png" 2>/dev/null || true)

          if [ -n "$png_files" ]; then
            echo "Found PNG files:"
            echo "$png_files"
            
            # Check if PNG files are valid
            invalid_files=""
            for file in $png_files; do
              if ! file "$file" | grep -q "PNG image"; then
                echo "âŒ Invalid PNG file: $file"
                invalid_files="$invalid_files $file"
              else
                echo "âœ… Valid PNG file: $file"
              fi
            done
            
            if [ -n "$invalid_files" ]; then
              echo "âŒ Found invalid PNG files:$invalid_files"
              exit 1
            fi
          else
            echo "â„¹ï¸ No PNG files found in dapps directory"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Validation Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.validate_json.outputs.json_valid }}" = "true" ]; then
            echo "âœ… JSON validation: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ JSON validation: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Requirements:" >> $GITHUB_STEP_SUMMARY
          echo "- All fields in \`Basic_Information\` must be present and non-empty" >> $GITHUB_STEP_SUMMARY
          echo "- Fields in \`Social_Profiles\` and \`Price_Data\` can be empty" >> $GITHUB_STEP_SUMMARY
          echo "- No additional fields are allowed in any section" >> $GITHUB_STEP_SUMMARY
          echo "- Icon files must be valid PNG format" >> $GITHUB_STEP_SUMMARY
